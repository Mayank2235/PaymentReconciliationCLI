-- 1. Invoices Table
CREATE TABLE IF NOT EXISTS invoices (
    id BIGSERIAL PRIMARY KEY,
    invoice_number VARCHAR(255) NOT NULL UNIQUE,
    amount NUMERIC(19, 2) NOT NULL,
    date DATE NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'UNMATCHED'
);

-- Index for faster searching by status (critical for reconciliation performance)
CREATE INDEX IF NOT EXISTS idx_invoice_status ON invoices(status);


-- 2. Payments Table
CREATE TABLE IF NOT EXISTS payments (
    id BIGSERIAL PRIMARY KEY,
    transaction_id VARCHAR(255) NOT NULL,
    amount NUMERIC(19, 2) NOT NULL,
    payment_date DATE NOT NULL,
    reference_note VARCHAR(255),
    status VARCHAR(50) NOT NULL DEFAULT 'UNMATCHED'
);

-- Index for status
CREATE INDEX IF NOT EXISTS idx_payment_status ON payments(status);


-- 3. Reconciliation Results Table (The Link)
CREATE TABLE IF NOT EXISTS reconciliations (
    id BIGSERIAL PRIMARY KEY,
    invoice_id BIGINT NOT NULL,
    payment_id BIGINT NOT NULL,
    match_type VARCHAR(50) NOT NULL, -- MATCHED, PARTIAL, etc.
    reconciled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_reconciliation_invoice FOREIGN KEY (invoice_id) REFERENCES invoices(id),
    CONSTRAINT fk_reconciliation_payment FOREIGN KEY (payment_id) REFERENCES payments(id)
);


-- 4. Audit Logs (Compliance)
CREATE TABLE IF NOT EXISTS audit_logs (
    id BIGSERIAL PRIMARY KEY,
    action VARCHAR(100) NOT NULL,
    details TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index for sorting logs by time quickly
CREATE INDEX IF NOT EXISTS idx_audit_timestamp ON audit_logs(timestamp);